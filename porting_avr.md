# AVRへの移植

ATmega328+秋月DRAMへの移植。

## コンセプト

秋月部品で作るCP/Mega88ということで、CPU/RAM/SDCARDの3点セットで
いろんな組み合わせを考える。

CPUは5V系と3.3V系、ふつうはSRAMでアドレスバッファ(74HC541/543)を1本から2本入れるのだが、
AVRCPMの小ピン設計がかっこういいので、28Pin ATmega328や、PIC32MXでもバッファなしで実現できないかと
考えた。

DRAMで/OE持っている場合(※)、アドレスバスとデータバスを結合してGPIOポート8本に繋いでも
構わないと思われた。これなら、アドレス/データ8本、/RAS, /CAS, /OE, /WEの12本で64kBRAMを
構成できる。

※: /OEがない場合、RAS/CAS入れて/WE==Hにしたままだとデータ出力状態になってしまう(Readサイクル)ので、
アドレスバスデータバス繋いでいると、CAS==Lにした直後からCPUからアドレス出力中とDRAMからデータ出力が衝突してしまう。

秋月のDRAMは、
+ 4Mbit(256k×16bit) 5V DRAM M11B416256A-35J(I-01451, 100円)
+ 4M×1bit 5V DRAM HM514100CLZ6(I-04156, 200円)
+ 128Mbit(8Mx16bit) 3.3V SDRAM HY57V281620ETP(I-07643, 100円)
+ 1Gbit 1.8V SDRAM MT47H64M16NF-25E(I-15399 500円)
が見つかるが、値段の安さで
+ 5V系: DRAM M11B416256A-35J, /OEあり
+ 3.3V系: SDRAM HY57V281620ETP
と決まる。

HY57V281620 SDRAMもデータシート見る限りではクロック同期で叩くだけで、これも/OEあればアドレス・データバス結合できそう。

#### 閑話休題

今気づいたが、PIC32MX370だとRAM128kB,FLASH 512kBでプログラムからFLASH読み書き可能。
ということで、これのみでCP/Mega88動くやんか。手元に1枚買ってあるので今度試してみよう。

PIC32MXだとMachiKaneaさんやかんぱぱさんの作例があるので親近感が湧くし。



## ピン割り当て

|ピン<br>番号|端子<br>名|接続<br>先|説明|
|--|--|--|--|
|23|PC0|TX|シリアルのTXに接続|
|24|PC1|RX|シリアルのRXに接続|
|28|PC5|CS|SDCardのCSに接続|
|26|PC3|DI|SDCardのDIに接続|
|25|PC2|SCK|SDcardのSCKに接続|
|27|PC4|DO|SDcardのDOに接続|
|2|PD0|AD0|DRAMのA0-IO0に接続|
|3|PD1|AD1|DRAMのA1-IO1に接続|
|4|PD2|AD2|DRAMのA2-IO2に接続|
|5|PD3|AD3|DRAMのA3-IO3に接続|
|6|PD4|AD4|DRAMのA4-IO4に接続|
|11|PD5|AD5|DRAMのA5-IO5に接続|
|12|PD6|AD6|DRAMのA6-IO6に接続|
|13|PD7|AD7|DRAMのA7-IO7に接続|
|14|PB0|/OE|DRAMの/OEに接続|
|15|PB1|/RAS|DRAMの/RASに接続|
|16|PB2|/CAS|DRAMの/CASに接続|
|17|PB3/MOSI|/WE<br>/MOSI|ProgrammerのMOSIに接続<br>DRAMの/WEに接続|
|18|PB4/MISO|MISO|ProgrammerのMISOに接続|
|19|PB5/SCK|SCK|ProgrammerのSCKに接続|
|1|RESET|RESET|ProgrammerのRESETに接続|

## ビルド
* arduino-cliを使う。
  + src/の下にicoファイルを置く。`src/src.ico`
  + コンパイルオプションを全て`hardware_config.h`に置く。
* 必要なファイルだけ残し他を消す。スクリプト`delete_...`を作ったが消えた。
* printf書式文字列をフラッシュ領域に格納し、SRAMを空ける。`debug.[ch]`の作成、`debug/debug0`関数。


## デバッグ

### コンソール

* まずコンソール、
* `con_getchar`が文字を返さない。最初のリターンの前に`asm volatile("nop");`を入れると動くようになる。コンパイラ最適化の効きすぎ?
* debug関数。static グローバルなchar配列(101バイト)上に`sprintf_P`関数を用いて文字列を展開し、それを`con_puts`で出力するようにした。
* LFをCRLFに展開する出力関数: `con_puts2`を作成。
* (後述)のちに、`con_puts`の文字列定数もグローバルバッファに`strcpy_P`を用いていったんコピーするようにした。これで1200バイト程度浮いた。

### SDカード

* SDカードソケット、レベルシフタの選定、中華デバイスは今回は使わない。airvariableさんの2N7000レベルシフタを採用する。

* 当初乱れた。レベルシフタの出来が悪い。結局、昔のSDcardソケット(秋月?)で作った2N7002レベルシフタ＋アダプタを参考にして、
  + CS/DI/DO/CLK全て10kで3.3Vにプルアップ。
  + 2N7000レベルシフタ(3.3V側Gate, 5V側Drain, Gateは3.3V直結)を使用。
  + 5V側はDOのみ5Vプルアップ
  
  で安定して動作するようになった。picoも4端子すべて10kでプルアップすると安定動作するのか？

* ソフト: pico版と挙動が異なる。`sdcard_avr.c`: オリジナルのコードで良く動く。これにFAT12,32,exFAT対応の`fat.c`の組み合わせで使っている。
  + CMD前のダミー8clkは追加した。ないと動かないか？
  + ダミー8clk追加しているが、カードNo18,19(Transcend 8GB)でも問題なく動いている。
  + `sdcard_init`で、CS,DI,CLKを1にしている(→CLKは0の方がよい)
  + 1ビット送受信ループにwaitを仕込んでいる。nop数個入れることも試してみたが、結局0nop(関数呼び出しとリターンのみ)で動作している。

* コードサイズ27000バイト、RAM使用量は、900バイト弱。
* 但し、printf系だけでなく、con_putsの文字列定数をすべてFLASHに移動している。移動無しでは2048バイトあふれてしまう。ここから、con_putsの文字列定数サイズは1200バイト程度と推察できる。



### DRAM

* 一筋縄ではいかない。アドレスバス-データバスを繋いで`PD0-7`に繋いでいる。
* RAS前後、CAS前後に1nopずつ入れて動き出した。nopなしでは読み出しが化けている様子。レベルシフタの信号安定に時間がかかっている(z80_picoのレベルシフタとしてMOS-FET方式を試したときも100nsぐらいディレイがあったことを思い出した)
* アドレス0xEF01でR/Wテストに失敗する。RAS/CAS入替、ビット反転すると0x01FEでひっかかる。但し、`mw`コマンドで該当アドレスを書き換えると、その後の`mr`コマンドで書き込んだデータを読み込めている。
* 決まったアドレスで引っかかる。
  + アクセス時のnop追加では挙動は変わらない。
  + デバイス故障も疑われるので、もう1つのデバイスで同じ回路を作り試してみる。
  + A9 == Lのバンクを使っているので、A9 == Hにしてみる(1本プルアップに換える)。
  + 電源不安定、10uF電解コンデンサをSDカード電源に渡してみる。
* 
### リフレッシュ
* `mills`でタイマ超えたらリフレッシュ呼び出しとしても腐ってしまう。調べてみると、`millis`は常にゼロを返していた。これではダメだ。
* キー入力待ち10万回に1回にCAS-before-RAS refreshを512回行っている。
* タイマを使ってきちんとやりたい。

